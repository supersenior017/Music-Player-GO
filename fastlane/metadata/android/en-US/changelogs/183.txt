Bug fixes

Thanks CodeCubeNeo, otaboard, lgjint
